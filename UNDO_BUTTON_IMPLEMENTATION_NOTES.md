# 一手戻るボタン実装メモ

## 要件定義

### 1. ボタンデザイン
- **テキスト**: 「一手戻る」
- **配置**: 左下（BGMボタンの反対側、BGMボタンは右下）
- **スタイル**: BGMボタンと同様の絶対配置
- **レスポンシブ**: スマホ画面でも見えるように
- **無効状態**: 半透明表示（opacity: 0.5程度）

### 2. 動作仕様

#### オフライン戦・オンライン戦
- **戻り先**: 一個前の手番の人の盤面
- **使用可能者**: 両プレイヤーが使用可能
- **使用タイミング**: 自分の番の時のみ
- **制限**: コネクト4が成立した直後の手番では使用不可

#### AI戦
- **戻り先**: 一個前のプレイヤーの手番の盤面（AIの手は削除）
- **使用可能者**: プレイヤーのみ（AIは使用不可）
- **使用タイミング**: プレイヤーの番の時のみ
- **制限**: 
  - コネクト4が成立した直後の手番では使用不可
  - AIの思考中は使用不可

### 3. 履歴管理
- **保存範囲**: 最大1ゲーム分のみ
- **制限**: コネクト4を跨ぐ実装は不可
- **理由**: ゲームを跨いで戻る必要がない

### 4. 使用できない状況
1. **コネクト4成立直後**: コネクト4が成立した次の手番では使用不可
2. **ゲーム開始前**: ゲームが開始されていない時
3. **ゲーム終了後**: ゲームが終了している時
4. **手番外**: 自分の番ではない時
5. **最初の手**: まだ手が置かれていない時
6. **AI思考中**: AIが思考・手を置いている最中（AI戦のみ）

### 5. 確認ダイアログ
- **表示**: ボタンクリック時に「本当に戻しますか？はい/いいえ」の確認
- **デザイン**: 既存のポップアップスタイルに合わせる

### 6. 状態の復元内容
- **戻される情報**: 盤面状態、手番、ゲーム履歴（最後の手を削除）
- **戻されない情報**: スコア、ゲーム設定、プレイヤー情報、タイマー

### 7. 複数回Undo
- **制限**: 最初の手まで戻れる（それ以上は無効）
- **連続使用**: 可能

## 起こりうる不具合の想定

### 1. 状態管理関連の不具合

#### 1.1 非同期状態更新の問題
- **問題**: Undo実行時に状態更新が非同期で行われるため、タイミングによっては正しく状態が復元されない
- **対策**: `useCallback`と`useEffect`を適切に組み合わせ、状態更新の順序を保証

#### 1.2 履歴データの整合性
- **問題**: 履歴から手を削除する際、盤面状態と履歴が一致しなくなる
- **対策**: 履歴削除と同時に盤面状態も確実に更新

### 2. ゲーム進行関連の不具合

#### 2.1 手番制御の混乱
- **問題**: Undo後に手番が正しく切り替わらない
- **対策**: 手番状態を履歴から正確に復元

#### 2.2 AI戦での複雑な状態
- **問題**: AIの手を削除する際、AIの思考状態やタイマーが正しくリセットされない
- **対策**: AI関連の状態を適切にリセット

### 3. UI/UX関連の不具合

#### 3.1 ボタンの有効/無効状態
- **問題**: 使用できない状況でもボタンが有効になってしまう
- **対策**: 複数の条件を組み合わせた厳密な有効/無効判定

#### 3.2 確認ダイアログの表示
- **問題**: ダイアログが適切なタイミングで表示されない
- **対策**: 状態管理を適切に行い、表示条件を明確化

### 4. パフォーマンス関連の不具合

#### 4.1 履歴のメモリ使用量
- **問題**: 履歴が大きくなりすぎてメモリ不足
- **対策**: 1ゲーム分のみ保存し、ゲーム終了時にクリア

#### 4.2 再レンダリングの過多
- **問題**: Undo実行時に不要な再レンダリングが発生
- **対策**: `useMemo`や`useCallback`で最適化

### 5. エッジケースの不具合

#### 5.1 同時操作
- **問題**: オンライン戦で相手がUndo中に自分も操作してしまう
- **対策**: 操作中の状態管理と適切な無効化

#### 5.2 アニメーション中の操作
- **問題**: コネクト4アニメーション中にUndoが実行される
- **対策**: アニメーション中の操作を無効化

### 6. 実装上の注意点

#### 6.1 既存コードとの整合性
- **問題**: 既存のゲーム進行ロジックとUndo機能が競合
- **対策**: 既存の関数を拡張し、新しい状態を追加

#### 6.2 型安全性
- **問題**: TypeScriptの型定義が不適切でランタイムエラー
- **対策**: 適切な型定義とバリデーション

## テストすべきシナリオ

1. **基本動作**: 通常のUndo操作
2. **連続Undo**: 複数回の連続Undo
3. **制限状態**: 使用できない状況でのボタン状態
4. **エラー処理**: 不正な状態でのUndo実行
5. **パフォーマンス**: 大量の手がある場合の動作
6. **レスポンシブ**: スマホ画面での表示と操作

## 実装順序

1. 型定義の追加（GameHistory, GameMove）
2. 履歴管理機能の実装
3. UndoButtonコンポーネントの作成
4. 各ゲーム画面への統合
5. 確認ダイアログの実装
6. テストとデバッグ

## 注意事項

- 既存のUI/UXに手を加えない
- 段階的に実装し、各段階でテスト
- パフォーマンスを考慮した実装
- エラーハンドリングを適切に行う 